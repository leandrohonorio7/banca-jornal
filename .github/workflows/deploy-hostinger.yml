name: Deploy to Hostinger

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'BancaJornal.sln'
  API_PROJECT: 'BancaJornal.Api/BancaJornal.Api.csproj'
  WEB_PROJECT: 'BancaJornal.Web/BancaJornal.Web.csproj'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}

    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

    - name: Run tests
      run: |
        echo "‚úì Tests passed or skipped (no test project configured yet)"
        # Quando adicionar testes, descomente:
        # dotnet test ${{ env.SOLUTION_PATH }} --no-build --verbosity normal --configuration Release
      continue-on-error: true

    - name: Publish API
      run: dotnet publish ${{ env.API_PROJECT }} -c Release -o ./publish/api --no-build

    - name: Publish Web
      run: dotnet publish ${{ env.WEB_PROJECT }} -c Release -o ./publish/web --no-build

    - name: Upload API artifact
      uses: actions/upload-artifact@v4
      with:
        name: api-artifact
        path: ./publish/api

    - name: Upload Web artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-artifact
        path: ./publish/web

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Hostinger via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        port: ${{ secrets.HOSTINGER_PORT }}
        passphrase: ${{ secrets.HOSTINGER_SSH_PASSPHRASE }}
        script: |
          echo "=========================================="
          echo "  üöÄ Deploy Autom√°tico - Banca Jornal"
          echo "=========================================="
          
          # Navegar para o diret√≥rio do projeto
          cd ${{ secrets.HOSTINGER_PROJECT_PATH }}
          
          echo "[1/8] üì• Baixando atualiza√ß√µes do GitHub..."
          git fetch origin
          git reset --hard origin/master || git reset --hard origin/main
          
          echo "[2/8] üíæ Backup do banco de dados..."
          if [ -f ./data/bancajornal.db ]; then
            cp ./data/bancajornal.db ./data/bancajornal.db.backup.$(date +%Y%m%d_%H%M%S)
            echo "‚úì Backup criado"
          else
            echo "‚ö† Banco de dados n√£o encontrado, ser√° criado na primeira execu√ß√£o"
          fi
          
          echo "[3/8] üõë Parando containers antigos..."
          docker-compose down
          
          echo "[4/8] üßπ Limpando recursos antigos..."
          docker-compose rm -f
          docker system prune -f
          
          echo "[5/8] üî® Buildando novos containers..."
          docker-compose build --no-cache
          
          echo "[6/8] üöÄ Iniciando containers..."
          docker-compose up -d
          
          echo "[7/8] ‚è≥ Aguardando containers iniciarem..."
          sleep 10
          
          echo "[8/8] ‚úÖ Verificando status..."
          docker-compose ps
          
          echo ""
          echo "üìã √öltimos logs:"
          docker-compose logs --tail=50 bancajornal_api
          
          echo ""
          echo "=========================================="
          echo "  ‚úì Deploy conclu√≠do com sucesso!"
          echo "=========================================="

    - name: Verify Deployment
      run: |
        echo "=========================================="
        echo "  ‚úÖ Deployment Completed Successfully!"
        echo "=========================================="
        echo ""
        echo "üì¶ Application: Banca Jornal"
        echo "üåø Branch: ${{ github.ref_name }}"
        echo "üë§ Triggered by: ${{ github.actor }}"
        echo "üí¨ Commit: ${{ github.event.head_commit.message }}"
        echo "üîñ SHA: ${{ github.sha }}"
        echo ""
        echo "üîó Access your application:"
        echo "   Frontend: https://${{ secrets.HOSTINGER_HOST }}"
        echo "   API Docs: https://${{ secrets.HOSTINGER_HOST }}/swagger"
        echo ""
        echo "üìä Monitor application:"
        echo "   ssh ${{ secrets.HOSTINGER_USERNAME }}@${{ secrets.HOSTINGER_HOST }}"
        echo "   cd ${{ secrets.HOSTINGER_PROJECT_PATH }}"
        echo "   docker-compose logs -f bancajornal_api"
        echo ""
        echo "=========================================="

    - name: Notify on Failure
      if: failure()
      run: |
        echo "=========================================="
        echo "  ‚ùå Deployment Failed!"
        echo "=========================================="
        echo ""
        echo "Check the logs above for details."
        echo "Common issues:"
        echo "  - GitHub Secrets not configured"
        echo "  - SSH connection failed"
        echo "  - Docker build errors"
        echo "  - Insufficient disk space on VPS"
        echo ""
        echo "Troubleshooting:"
        echo "  1. Verify GitHub Secrets are set correctly"
        echo "  2. Check VPS is accessible via SSH"
        echo "  3. Ensure Docker and Docker Compose are installed"
        echo "  4. Check disk space: df -h"
        echo "  5. Review logs in Actions tab"
        echo ""
        echo "=========================================="
